<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ATS simple (cliente) - Demo</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:18px;max-width:900px}
    label{display:block;margin-top:10px}
    textarea{width:100%;min-height:120px}
    .card{border:1px solid #ddd;padding:12px;border-radius:8px;margin-top:12px}
    .score{font-weight:700}
    button{margin-top:8px}
    pre{background:#f7f7f7;padding:10px;overflow:auto}
  </style>
</head>
<body>
  <h1>ATS simple (cliente) — Demo</h1>
  <p>Sube una hoja de vida (PDF) y elige cargo + capítulo (universidad). El análisis se hace <strong>completamente en el navegador</strong>. Para revisión de presentación (gramática/ortografía) la demo usa LanguageTool (servicio público con límites).</p>

  <div class="card">
    <label>Nombre del aspirante
      <input id="name" placeholder="Ej. María Pérez" />
    </label>
    <label>Cargo
      <select id="cargo"></select>
    </label>
    <label>Capítulo (Universidad)
      <select id="capitulo"></select>
    </label>
    <label>Subir Hoja de vida (PDF)
      <input id="file" type="file" accept="application/pdf" />
    </label>
    <button id="analyze">Analizar hoja de vida</button>
  </div>

  <div id="output"></div>

  <h3>Notas</h3>
  <ul>
    <li>Los listados de <code>Funciones</code> y <code>Perfiles</code> y las <code>palabras clave</code> por capítulo deben colocarse como archivos JSON en la carpeta <code>/data</code> del repo. Ver README en el proyecto para el formato.</li>
    <li>LanguageTool es público pero tiene límites. Si lo vas a usar mucho, considera desplegar tu propia instancia o pedir permiso.</li>
    <li>Esta es una base — puedes mejorar el ranking o la lógica de mapeo a 1..5 según necesites.</li>
  </ul>

  <!-- Librerías desde CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.8.162/pdf.min.js"></script>
  <script src="https://unpkg.com/elasticlunr/elasticlunr.js"></script>

  <script>
  // --- CONFIG: cargos/archivos JSON ---
  // Esperamos que el repo tenga /data/cargos.json y /data/keywords.json
  // formatos de ejemplo (ver README en repo):
  // cargos.json = { "PC": {"functions":["..."], "profile":["..."] , "indicators":["ind1","ind2","ind3"]}, ... }
  // keywords.json = { "Universidad A": {"PC": { "ind1": ["kw1","kw2"], "ind2":[...], "ind3":[...] } , ... }, ... }

  const cargoSelect = document.getElementById('cargo')
  const capSelect = document.getElementById('capitulo')
  const analyzeBtn = document.getElementById('analyze')
  const fileInput = document.getElementById('file')
  const out = document.getElementById('output')

  let cargosData = {}
  let keywordsData = {}

  // Cargar datos JSON desde /data (estos archivos debes crear en tu repo)
  async function loadConfigs(){
    try{
      cargosData = await (await fetch('./data/cargos.json')).json()
      keywordsData = await (await fetch('./data/keywords.json')).json()
    }catch(e){
      console.warn('No se encontraron archivos de configuración en ./data. Usa el editor de GitHub para crear them.');
      cargosData = {
        "PC": { functions:["liderar equipo","organizar eventos"], profile:["comunicacion","liderazgo"], indicators:["I1","I2","I3"] },
        "IC": { functions:["desarrollar proyectos"], profile:["analitico"], indicators:["I1","I2","I3"] }
      }
      keywordsData = {"Universidad Demo": {"PC": {"I1":["evento","coordinar"],"I2":["lider","gerente"],"I3":["proyecto"]}}}
    }
    // llenar selects
    cargoSelect.innerHTML = Object.keys(cargosData).map(k=>`<option value="${k}">${k}</option>`).join('')
    capSelect.innerHTML = Object.keys(keywordsData).map(k=>`<option value="${k}">${k}</option>`).join('')
  }

  // --- PDF text extraction using pdf.js ---
  async function extractTextFromPdf(file){
    const arrayBuffer = await file.arrayBuffer()
    const pdf = await pdfjsLib.getDocument({data:arrayBuffer}).promise
    let full = ''
    for(let i=1;i<=pdf.numPages;i++){
      const page = await pdf.getPage(i)
      const content = await page.getTextContent()
      const strings = content.items.map(it=>it.str)
      full += strings.join(' ') + '\n'
    }
    return full
  }

  // --- Simple text preprocessing ---
  function tokenize(s){
    return s.toLowerCase().replace(/[^\p{L}\d\s]/gu,' ').split(/\s+/).filter(Boolean)
  }

  // build frequency map
  function freq(tokens){
    const f = {}
    for(const t of tokens) f[t]=(f[t]||0)+1
    return f
  }

  // cosine similarity for two freq maps
  function cosine(a,b){
    let dot=0, na=0, nb=0
    for(const k in a){ if(b[k]) dot += a[k]*b[k]; na += a[k]*a[k] }
    for(const k in b) nb += b[k]*b[k]
    if(na===0||nb===0) return 0
    return dot / (Math.sqrt(na)*Math.sqrt(nb))
  }

  // aggregate list into frequency
  function listToFreq(list){
    return freq(tokenize(list.join(' ')))
  }

  // map similarity [0..1] -> score 1..5
  function simToScore(sim){
    if(sim>0.65) return 5
    if(sim>0.45) return 4
    if(sim>0.30) return 3
    if(sim>0.15) return 2
    return 1
  }

  // LanguageTool check (presentation). Uses public API (subject to limits). If it fails, fallback to basic heuristics.
  async function checkPresentation(text){
    try{
      const form = new URLSearchParams(); form.append('text', text); form.append('language','es')
      const res = await fetch('https://api.languagetool.org/v2/check', {method:'POST', body:form})
      if(!res.ok) throw new Error('LT error')
      const data = await res.json()
      // compute a simple presentation score: fewer matches -> better
      const issues = data.matches.length
      // normalize (arbitrary): issues 0->5, 1-3->4, 4-6->3, 7-12->2, >12->1
      if(issues===0) return {score:5, issues:data.matches}
      if(issues<=3) return {score:4, issues:data.matches}
      if(issues<=6) return {score:3, issues:data.matches}
      if(issues<=12) return {score:2, issues:data.matches}
      return {score:1, issues:data.matches}
    }catch(e){
      // fallback heuristic: sentence length/unusual characters
      const sentences = text.split(/[\.\n\?\!]+/).filter(Boolean)
      const longS = sentences.filter(s=>s.split(' ').length>40).length
      const score = longS>3?2: (longS>0?3:5)
      return {score, issues:[]}
    }
  }

  // Main analysis routine
  async function analyze(name, cargo, capitulo, text){
    const tokens = tokenize(text)
    const tfResume = freq(tokens)

    const cargoObj = cargosData[cargo]
    const keywordsForChapter = (keywordsData[capitulo] && keywordsData[capitulo][cargo]) || {}

    // Profile & Functions evaluation
    const fFreq = listToFreq(cargoObj.functions || [])
    const pFreq = listToFreq(cargoObj.profile || [])
    const simFunctions = cosine(tfResume, fFreq)
    const simProfile = cosine(tfResume, pFreq)
    const scoreFunctions = simToScore(simFunctions)
    const scoreProfile = simToScore(simProfile)

    // Indicators (keywords): compute similarity per indicator
    const indicators = cargoObj.indicators || Object.keys(keywordsForChapter)
    const indicatorScores = []
    for(const ind of indicators){
      const kws = (keywordsForChapter && keywordsForChapter[ind]) || []
      const kFreq = listToFreq(kws)
      const sim = cosine(tfResume, kFreq)
      indicatorScores.push({indicator:ind, sim, score:simToScore(sim)})
    }

    // Presentation
    const presentation = await checkPresentation(text)

    // Global results: average per section
    const sectionScores = {
      Perfil: Math.round((scoreFunctions+scoreProfile)/2),
      Experiencia_ANEIAP: Math.round(indicatorScores.reduce((s,i)=>s+i.score,0)/indicatorScores.length || 1),
      Presentacion: presentation.score
    }

    // Comentarios automáticos sencillos
    const comments = []
    if(simFunctions<0.2) comments.push('Poca evidencia de tareas concretas del cargo en la hoja de vida.')
    if(simProfile<0.2) comments.push('Perfil mostrado difiere del perfil esperado para el cargo.')
    const lowInd = indicatorScores.filter(i=>i.score<=2).map(i=>i.indicator)
    if(lowInd.length) comments.push('Indicadores con coincidencias débiles: '+lowInd.join(', '))
    if(presentation.score<=2) comments.push('Presentación con varios errores sugeridos—revisar gramática/ortografía y organización.')

    return {name,cargo,capitulo, simFunctions, simProfile, scoreFunctions, scoreProfile, indicatorScores, presentation, sectionScores, comments}
  }

  // UI wiring
  analyzeBtn.addEventListener('click', async ()=>{
    out.innerHTML = '<p>Analizando...</p>'
    const name = document.getElementById('name').value || 'Sin nombre'
    const cargo = cargoSelect.value
    const cap = capSelect.value
    const file = fileInput.files[0]
    if(!file){ out.innerHTML = '<p style="color:darkred">Sube un PDF antes de analizar.</p>'; return }
    try{
      const text = await extractTextFromPdf(file)
      const res = await analyze(name,cargo,cap,text)
      renderResult(res,text)
    }catch(e){
      out.innerHTML = '<pre>Error: '+e.message+'</pre>'
      console.error(e)
    }
  })

  function renderResult(r,text){
    out.innerHTML = ''
    const title = document.createElement('h2')
    title.textContent = `Análisis hoja de vida — ${r.name} — ${r.cargo}`
    out.appendChild(title)

    const sec = document.createElement('div')
    sec.className='card'
    sec.innerHTML = `
      <p><strong>Resultados globales por sección:</strong></p>
      <ul>
        <li>Perfil (Funciones y Perfil): <span class="score">${r.sectionScores.Perfil}</span></li>
        <li>Experiencia/Indicadores: <span class="score">${r.sectionScores.Experiencia_ANEIAP}</span></li>
        <li>Presentación: <span class="score">${r.sectionScores.Presentacion}</span></li>
      </ul>
      <p><strong>Evaluación de perfil (detalles):</strong></p>
      <p>Similitud con funciones: ${r.simFunctions.toFixed(3)} → score ${r.scoreFunctions}</p>
      <p>Similitud con perfil: ${r.simProfile.toFixed(3)} → score ${r.scoreProfile}</p>
    `
    out.appendChild(sec)

    const indCard = document.createElement('div')
    indCard.className='card'
    indCard.innerHTML = '<strong>Indicadores por indicador</strong>' + '<ul>' + r.indicatorScores.map(i=>`<li>${i.indicator}: sim ${i.sim.toFixed(3)} → score ${i.score}</li>`).join('') + '</ul>'
    out.appendChild(indCard)

    const presCard = document.createElement('div')
    presCard.className='card'
    presCard.innerHTML = `<strong>Presentación</strong><p>Score: ${r.presentation.score}</p><p>Issues detectados: ${r.presentation.issues.length}</p>`
    out.appendChild(presCard)

    const comments = document.createElement('div')
    comments.className='card'
    comments.innerHTML = '<strong>Comentarios finales</strong><ul>' + (r.comments.length? r.comments.map(c=>`<li>${c}</li>`).join('') : '<li>Sin observaciones</li>') + '</ul>'
    out.appendChild(comments)

    // permitir descargar reporte simple
    const download = document.createElement('button')
    download.textContent = 'Descargar reporte (TXT)'
    download.addEventListener('click', ()=>{
      const blob = new Blob([generateTextReport(r)], {type:'text/plain'})
      const url = URL.createObjectURL(blob)
      const a = document.createElement('a'); a.href=url; a.download = `analisis_${r.name.replace(/\s+/g,'_')}_${r.cargo}.txt`; a.click(); URL.revokeObjectURL(url)
    })
    out.appendChild(download)
  }

  function generateTextReport(r){
    return `Análisis hoja de vida ${r.name} — ${r.cargo}\n\nResultados globales:\nPerfil: ${r.sectionScores.Perfil}\nExperiencia/Indicadores: ${r.sectionScores.Experiencia_ANEIAP}\nPresentación: ${r.sectionScores.Presentacion}\n\nDetalles:\nSim funciones: ${r.simFunctions.toFixed(3)} score ${r.scoreFunctions}\nSim perfil: ${r.simProfile.toFixed(3)} score ${r.scoreProfile}\n\nIndicadores:\n${r.indicatorScores.map(i=>`${i.indicator}: score ${i.score} sim ${i.sim.toFixed(3)}`).join('\n')}\n\nComentarios:\n${r.comments.join('\n')}`
  }

  // init
  loadConfigs()
  </script>
</body>
</html>
