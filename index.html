<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ATS - Evaluación de hojas de vida (Starter)</title>
  <style>
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;max-width:980px;margin:18px auto;padding:18px}
    header{display:flex;align-items:center;gap:12px}
    h1{font-size:1.4rem;margin:0}
    label{display:block;margin:10px 0 4px}
    input,select,button{padding:8px;border-radius:6px;border:1px solid #ccc;width:100%}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    pre{white-space:pre-wrap;background:#fafafa;padding:12px;border-radius:8px;border:1px solid #eee}
    .card{padding:12px;border-radius:8px;border:1px solid #eee;background:#fff;margin-top:12px}
  </style>
  <!-- Libraries (CDN) -->
  <!-- pdf.js (to extract text from uploaded PDF CV) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.7.107/pdf.min.js"></script>
  <!-- Fuse.js for fuzzy keyword matching -->
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js"></script>
</head>
<body>
  <header>
    <img src="data:;base64,iVBORw0KGgo=" alt="logo" style="width:56px;height:56px;background:#eee;border-radius:8px"/>
    <div>
      <h1>ATS simple (starter) — Evaluación automática de hojas de vida</h1>
      <small>Sube tu CV, selecciona capítulo y cargo. La evaluación se realiza en el navegador (100% gratis).</small>
    </div>
  </header>

  <section class="card">
    <label for="name">Nombre del aspirante</label>
    <input id="name" placeholder="Ej: María Pérez" />

    <label for="chapter">Capítulo / Universidad</label>
    <select id="chapter">
      <option value="u1">Universidad A</option>
      <option value="u2">Universidad B</option>
    </select>

    <label for="position">Cargo al que aspira</label>
    <select id="position">
      <option value="PC">PC</option>
      <option value="IC">IC</option>
      <option value="CCP">CCP</option>
      <option value="DCA">DCA</option>
      <option value="DCC">DCC</option>
      <option value="DCD">DCD</option>
      <option value="DCF">DCF</option>
      <option value="DCM">DCM</option>
    </select>

    <label for="cvfile">Hoja de vida (PDF)</label>
    <input id="cvfile" type="file" accept="application/pdf" />

    <div style="margin-top:12px;display:flex;gap:8px">
      <button id="run">Generar análisis</button>
      <button id="reset">Limpiar</button>
    </div>

    <small style="display:block;margin-top:8px">Nota: Para que el análisis use las listas de funciones/perfiles e indicadores, sube esos archivos al repositorio y actualiza las rutas en <code>dataConfig</code> (ver README en repo).</small>
  </section>

  <section id="output" class="card" style="display:none">
    <h2 id="title"></h2>
    <div id="summary"></div>
    <h3>Resultados por sección</h3>
    <div id="results"></div>
    <h3>Comentarios finales</h3>
    <pre id="comments"></pre>
  </section>

  <script>
  // --------------------- CONFIG (edit these file paths in your repo) ---------------------
  // Put your FXX.pdf and PXX.pdf converted to plain lists, OR better: export the lists to JSON and place them
  // into the repo and update paths here. Example structure in repo: /data/functions_PC.json /data/profiles_PC.json /data/indicators.json /data/keywords_by_university.json
  const dataConfig = {
    functionsBase: '/data/functions_', // append POSITION + '.json'
    profilesBase: '/data/profiles_',
    indicatorsFile: '/data/indicators.json',
    keywordsFile: '/data/keywords_by_university.json'
  };

  // --------------------- HELPERS ---------------------
  async function fetchJson(path){ try{ const r = await fetch(path); if(!r.ok) throw new Error('not found'); return await r.json(); }catch(e){ return null; } }

  function cleanText(t){ return t.replace(/[\n\r]+/g,' ').replace(/\s+/g,' ').trim().toLowerCase(); }

  function jaccard(a,b){ const A = new Set(a.split(' ')); const B = new Set(b.split(' ')); const inter = [...A].filter(x=>B.has(x)); return inter.length / (new Set([...A,...B]).size || 1); }

  // simple tokenizer
  function tokens(text){ return cleanText(text).split(/\s+/).filter(Boolean); }

  // ----------------- PDF extraction -----------------
  async function pdfToText(file){
    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
    let full='';
    for(let i=1;i<=pdf.numPages;i++){
      const page = await pdf.getPage(i);
      const content = await page.getTextContent();
      const pageText = content.items.map(it=>it.str).join(' ');
      full += ' ' + pageText;
    }
    return full;
  }

  // ----------------- Scoring logic (simple, client-side) -----------------
  async function analyze(cvText, chapter, position, functionsList, profilesList, indicators, keywordsByUni){
    const out = {};
    const cleanCv = cleanText(cvText);

    // 1) Perfil: compare CV vs functions list and profile list
    const funcScores = functionsList.map(item=> ({item, score: jaccard(cleanCv,item)})).sort((a,b)=>b.score-a.score);
    const profScores = profilesList.map(item=> ({item, score: jaccard(cleanCv,item)})).sort((a,b)=>b.score-a.score);
    out.perfil = {functionsTop:funcScores.slice(0,5), profilesTop:profScores.slice(0,5)};

    // 2) Indicadores: for each indicator (three per position) measure keyword coverage for the selected chapter
    out.indicadores = [];
    const uniKeywords = (keywordsByUni[chapter] && keywordsByUni[chapter][position]) || {};
    for(const ind of indicators[position] || []){
      const kwList = uniKeywords[ind] || [];
      const matches = kwList.map(kw => ({kw, present: cleanCv.includes(kw.toLowerCase())}));
      const matchedCount = matches.filter(m=>m.present).length;
      out.indicadores.push({indicator:ind, keywords:matches, matchedCount});
    }

    // 3) Presentacion: basic heuristics
    const words = tokens(cleanCv);
    const sentences = cvText.split(/[\.\!\?]+/).map(s=>s.trim()).filter(Boolean);
    const avgWordsPerSentence = sentences.length? Math.round(words.length / sentences.length): 0;
    const longWordsPercent = words.filter(w=>w.length>12).length / (words.length||1);
    const repeatedSpaces = /\s{2,}/.test(cvText);
    out.presentacion = {wordsCount:words.length, sentencesCount:sentences.length, avgWordsPerSentence, longWordsPercent, repeatedSpaces};

    // 4) Overall: combine simple normalized scores
    const funcScore = funcScores[0]?.score||0; const profScore = profScores[0]?.score||0;
    const indicatorScore = out.indicadores.length? (out.indicadores.reduce((s,i)=>s+i.matchedCount,0) / (out.indicadores.length*5)) : 0; // assume up to 5 keywords
    const presentationScore = Math.max(0, 1 - longWordsPercent - (repeatedSpaces?0.1:0) - Math.abs(avgWordsPerSentence-20)/100 );
    out.global = {
      funcScore: Math.round(funcScore*100),
      profScore: Math.round(profScore*100),
      indicatorScore: Math.round(indicatorScore*100),
      presentationScore: Math.round(presentationScore*100),
      total: Math.round((funcScore+profScore+indicatorScore+presentationScore)/4*100)
    };

    return out;
  }

  // ----------------- UI wiring -----------------
  document.getElementById('run').addEventListener('click', async ()=>{
    const name = document.getElementById('name').value || 'Sin nombre';
    const chapter = document.getElementById('chapter').value;
    const position = document.getElementById('position').value;
    const file = document.getElementById('cvfile').files[0];
    if(!file){ alert('Sube la hoja de vida en PDF'); return; }

    // load configured data
    const functionsList = await fetchJson(dataConfig.functionsBase + position + '.json') || ['(falta archivo functions)'];
    const profilesList = await fetchJson(dataConfig.profilesBase + position + '.json') || ['(falta archivo profiles)'];
    const indicators = await fetchJson(dataConfig.indicatorsFile) || {};
    const keywordsByUni = await fetchJson(dataConfig.keywordsFile) || {};

    // extract text
    const cvText = await pdfToText(file);

    // analyze
    const res = await analyze(cvText, chapter, position, functionsList, profilesList, indicators, keywordsByUni);

    // render
    document.getElementById('output').style.display='block';
    document.getElementById('title').innerText = `Análisis hoja de vida — ${name} — ${position}`;
    document.getElementById('summary').innerHTML = `<strong>Puntaje total estimado:</strong> ${res.global.total}% — (Funcion ${res.global.funcScore}%, Perfil ${res.global.profScore}%, Indicadores ${res.global.indicatorScore}%, Presentación ${res.global.presentationScore}%)`;

    const rdiv = document.getElementById('results'); rdiv.innerHTML='';
    const p1 = document.createElement('div'); p1.innerHTML = `<h4>Perfil - funciones (top matches)</h4><pre>${res.perfil.functionsTop.map(x=>`${Math.round(x.score*100)}% — ${x.item}`).join('\n')}</pre>`;
    const p2 = document.createElement('div'); p2.innerHTML = `<h4>Perfil - características (top matches)</h4><pre>${res.perfil.profilesTop.map(x=>`${Math.round(x.score*100)}% — ${x.item}`).join('\n')}</pre>`;
    rdiv.appendChild(p1); rdiv.appendChild(p2);

    const indDiv = document.createElement('div'); indDiv.innerHTML = `<h4>Indicadores (por indicador)</h4>${res.indicadores.map(i=>`<div><strong>${i.indicator}</strong> — Matched: ${i.matchedCount}/${i.keywords.length}<pre>${i.keywords.map(k=>`${k.present? '✔':'✖'} ${k.kw}`).join('\n')}</pre></div>`).join('')}`;
    rdiv.appendChild(indDiv);

    document.getElementById('comments').innerText = `Sugerencias:\n- Revisar ortografía y coherencia general (este starter hace chequeos heurísticos; para un análisis avanzado considera integrar LanguageTool).\n- Enfatizar en el CV ejemplos concretos que muestren las funciones listadas para aumentar la similitud.\n- Aumentar detalle en eventos organizados y participación en proyectos ANEIAP.`;
  });

  document.getElementById('reset').addEventListener('click', ()=>{ document.getElementById('name').value=''; document.getElementById('cvfile').value=''; document.getElementById('output').style.display='none'; });
  </script>
</body>
</html>
